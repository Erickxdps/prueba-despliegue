{% extends "base.html" %}

{% block title %}Gesti√≥n de Multas{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-gavel"></i> Gesti√≥n de Multas üò°
                        </h4>
                        <a href="{{ url_for('multa.create_multa') }}" class="btn btn-light btn-sm">
                            <i class="fas fa-plus"></i> Nueva Multa
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if multas %}
                    <!-- Estad√≠sticas generales -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-chart-line"></i> Estad√≠sticas Generales</h6>
                            <div class="row">
                                {% set duenos_unicos = multas|map(attribute='duenio.id')|unique|list %}
                                {% set total_duenos = duenos_unicos|length %}
                                {% set total_multas = multas|length %}
                                {% set multas_inasistencia = multas|selectattr('tipo', 'equalto', 'inasistencia')|list|length %}
                                {% set monto_total = multas|sum(attribute='monto') %}
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-info">
                                        <div class="card-body text-center">
                                            <h5 class="text-info">
                                                <i class="fas fa-users"></i> Propietarios
                                            </h5>
                                            <h3 class="text-info">{{ total_duenos }}</h3>
                                            <small class="text-muted">Con multas</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <h5 class="text-danger">
                                                <i class="fas fa-gavel"></i> Total Multas
                                            </h5>
                                            <h3 class="text-danger">{{ total_multas }}</h3>
                                            <small class="text-muted">Registradas</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h5 class="text-warning">
                                                <i class="fas fa-user-times"></i> Inasistencias
                                            </h5>
                                            <h3 class="text-warning">{{ multas_inasistencia }}</h3>
                                            <small class="text-muted">Por ausencia</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h5 class="text-success">
                                                <i class="fas fa-dollar-sign"></i> Total
                                            </h5>
                                            <h3 class="text-success">Bs. {{ monto_total|int }}</h3>
                                            <small class="text-muted">Monto total</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dueniosMultasTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Propietario</th>
                                    <th>Resumen de Multas</th>
                                    <th>Terrenos</th>
                                    <th>Ver Detalles</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set duenos_procesados = [] %}
                                {% for multa in multas %}
                                    {% if multa.duenio.id not in duenos_procesados %}
                                        {% set _ = duenos_procesados.append(multa.duenio.id) %}
                                        {% set multas_dueno = multas|selectattr('duenio.id', 'equalto', multa.duenio.id)|list %}
                                        {% set inasistencia_count = multas_dueno|selectattr('tipo', 'equalto', 'inasistencia')|list|length %}
                                        {% set otras_count = multas_dueno|selectattr('tipo', 'ne', 'inasistencia')|list|length %}
                                        {% set total_dueno = multas_dueno|length %}
                                        {% set monto_total_dueno = multas_dueno|sum(attribute='monto') %}
                                        {% set terrenos_dueno = multa.duenio.terrenos %}
                                        
                                        <tr>
                                            <td><strong>#{{ multa.duenio.id }}</strong></td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="me-3">
                                                        <div class="avatar bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 45px; height: 45px; font-size: 14px; font-weight: 600;">
                                                            {{ multa.duenio.nombre[0]|upper }}{{ (multa.duenio.paterno[0] if multa.duenio.paterno else '')|upper }}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <strong>{{ multa.duenio.nombre }} {{ multa.duenio.paterno or '' }} {{ multa.duenio.materno or '' }}</strong>
                                                        <br><small class="text-muted">CI: {{ multa.duenio.ci or 'Sin CI' }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex gap-2 mb-2">
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-user-times"></i> {{ inasistencia_count }} Inasistencia
                                                    </span>
                                                    {% if otras_count > 0 %}
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-exclamation-triangle"></i> {{ otras_count }} Otras
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">Total: {{ total_dueno }} multas</small>
                                                    <strong class="text-danger">Bs. {{ monto_total_dueno|int }}</strong>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-wrap gap-1">
                                                    {% for terreno in terrenos_dueno %}
                                                    <span class="badge bg-light text-dark">
                                                        <i class="fas fa-map-marker-alt"></i> {{ terreno.lugar }} - Mz. {{ terreno.manzano }}
                                                    </span>
                                                    {% endfor %}
                                                </div>
                                                <small class="text-info d-block mt-1">{{ terrenos_dueno|length }} terreno{% if terrenos_dueno|length != 1 %}s{% endif %} total</small>
                                            </td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm verMultasBtn"
                                                    data-dueno="{{ multa.duenio.id }}"
                                                    data-nombre="{{ multa.duenio.nombre }} {{ multa.duenio.paterno or '' }}"
                                                    data-multas='[{% for m in multas_dueno %}{"id": {{ m.multa_id }}, "tipo": "{{ m.tipo }}", "descripcion": "{{ m.descripcion }}", "monto": {{ m.monto }}, "fecha": "{{ m.fecha.strftime('%d/%m/%Y') }}"}{% if not loop.last %},{% endif %}{% endfor %}]'>
                                                    <i class="fas fa-eye"></i> Ver Multas
                                                </button>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-5">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="fas fa-gavel fa-3x mb-3 text-muted opacity-50"></i>
                                            <h5 class="text-muted">Sin registros</h5>
                                            <p class="mb-0">No hay multas registradas</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver multas -->
<div class="modal fade" id="verMultasModal" tabindex="-1" aria-labelledby="verMultasModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="verMultasModalLabel">
          <i class="fas fa-gavel"></i> Historial de Multas - <span id="nombreDuenoMultas"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="contenidoMultas">
          <div class="text-center">
            <div class="spinner-border text-danger" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(220, 53, 69, 0.1);
}
.btn-group .btn { margin-right: 2px; }
.card-header { border-bottom: 3px solid rgba(255, 255, 255, 0.2); }
.badge { font-size: 0.75em; }
.avatar {
    font-weight: 600;
    font-size: 11px !important;
}
</style>

<script>
// Variable global para el modal
let modalMultas = null;

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar el modal
    const modalElement = document.getElementById('verMultasModal');
    if (modalElement) {
        modalMultas = new bootstrap.Modal(modalElement);
    }
    
    // Manejar clicks en los botones "Ver"
    document.querySelectorAll('.verMultasBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            const duenioId = this.dataset.dueno;
            const nombreDuenio = this.dataset.nombre;
            const multasData = this.dataset.multas ? JSON.parse(this.dataset.multas) : [];
            
            // Actualizar t√≠tulo del modal
            document.getElementById('nombreDuenoMultas').textContent = nombreDuenio;
            
            // Mostrar spinner mientras carga
            document.getElementById('contenidoMultas').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando historial de multas...</p>
                </div>`;
            
            // Mostrar modal
            if (modalMultas) {
                modalMultas.show();
            }
            
            // Generar contenido del historial
            setTimeout(() => {
                mostrarHistorialMultas(duenioId, nombreDuenio, multasData);
            }, 500);
        });
    });
});

function mostrarHistorialMultas(duenioId, nombreDuenio, multasData) {
    // Construir la tabla de multas
    let contenidoHTML = `
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th><i class="fas fa-tag text-warning"></i> Tipo</th>
                        <th><i class="fas fa-comment text-info"></i> Descripci√≥n</th>
                        <th><i class="fas fa-dollar-sign text-success"></i> Monto</th>
                        <th><i class="fas fa-calendar text-primary"></i> Fecha</th>
                        <th class="text-center"><i class="fas fa-cogs"></i> Acciones</th>
                    </tr>
                </thead>
                <tbody>`;

    if (multasData && multasData.length > 0) {
        let totalMonto = 0;
        let inasistencias = 0;
        
        multasData.forEach(multa => {
            totalMonto += parseFloat(multa.monto);
            if (multa.tipo === 'inasistencia') inasistencias++;
            
            let tipoBadge = '';
            if (multa.tipo === 'inasistencia') {
                tipoBadge = '<span class="badge bg-warning"><i class="fas fa-user-times"></i> Inasistencia</span>';
            } else if (multa.tipo === 'incumplimiento') {
                tipoBadge = '<span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Incumplimiento</span>';
            } else {
                tipoBadge = `<span class="badge bg-info"><i class="fas fa-info-circle"></i> ${multa.tipo.charAt(0).toUpperCase() + multa.tipo.slice(1)}</span>`;
            }
            
            contenidoHTML += `
                <tr>
                    <td>${tipoBadge}</td>
                    <td>
                        <span class="text-dark">${multa.descripcion}</span>
                    </td>
                    <td>
                        <strong class="text-danger">Bs. ${parseFloat(multa.monto).toFixed(0)}</strong>
                    </td>
                    <td>
                        <small class="text-muted">${multa.fecha}</small>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="/multas/${multa.id}/update" 
                               class="btn btn-outline-info btn-sm" 
                               title="Editar multa">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="confirmarEliminacionMulta(${multa.id})" 
                                    class="btn btn-outline-danger btn-sm" 
                                    title="Eliminar multa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
        
        // Calcular estad√≠sticas
        const otrasMultas = multasData.length - inasistencias;
        
        contenidoHTML += `
                </tbody>
            </table>
        </div>
        
        <!-- Resumen de estad√≠sticas -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-light border">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <i class="fas fa-gavel text-danger"></i>
                            <strong class="d-block">Total multas</strong>
                            <span class="text-muted">${multasData.length}</span>
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-user-times text-warning"></i>
                            <strong class="d-block">Inasistencias</strong>
                            <span class="text-warning">${inasistencias}</span>
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-exclamation-triangle text-info"></i>
                            <strong class="d-block">Otras causas</strong>
                            <span class="text-info">${otrasMultas}</span>
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-dollar-sign text-success"></i>
                            <strong class="d-block">Monto total</strong>
                            <span class="text-danger">Bs. ${totalMonto.toFixed(0)}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    } else {
        contenidoHTML += `
            <tr>
                <td colspan="5" class="text-center text-muted py-5">
                    <div class="d-flex flex-column align-items-center">
                        <i class="fas fa-gavel fa-3x mb-3 text-muted opacity-50"></i>
                        <h5 class="text-muted">Sin registros</h5>
                        <p class="mb-0">No hay multas registradas para <strong>${nombreDuenio}</strong></p>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>`;
    }
    
    // Actualizar contenido del modal
    document.getElementById('contenidoMultas').innerHTML = contenidoHTML;
}

function confirmarEliminacionMulta(multaId) {
    if (confirm('¬øEst√° seguro de que desea eliminar esta multa?\\n\\nEsta acci√≥n no se puede deshacer.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/multas/${multaId}/delete`;
        
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
