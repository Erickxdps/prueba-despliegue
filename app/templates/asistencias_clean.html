{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-user-check"></i> Gestión de Asistencias
                        </h4>
                        {% if current_user.has_role('admin') %}
                        <a href="{{ url_for('asistencia.create_asistencia') }}" class="btn btn-light btn-sm">
                            <i class="fas fa-plus"></i> Nueva Asistencia
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <!-- Barra de búsqueda -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <form method="GET" action="{{ url_for('asistencia.list_asistencias') }}" class="d-flex align-items-center">
                                <div class="input-group" style="max-width: 400px;">
                                    <input type="text" 
                                           name="search" 
                                           class="form-control" 
                                           placeholder="Buscar por dueño o reunión..." 
                                           value="{{ search }}">
                                    <button class="btn btn-outline-success" type="submit">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                {% if search %}
                                <a href="{{ url_for('asistencia.list_asistencias') }}" class="btn btn-outline-secondary ms-2">
                                    <i class="fas fa-times"></i> Limpiar
                                </a>
                                {% endif %}
                            </form>
                        </div>
                        <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
                            {% if asistencias_paginated and asistencias_paginated.total > 0 %}
                            <small class="text-muted">
                                <i class="fas fa-user-check"></i> 
                                {{ asistencias_paginated.per_page * (asistencias_paginated.page - 1) + 1 }}
                                - {{ asistencias_paginated.per_page * (asistencias_paginated.page - 1) + asistencias|length }} 
                                de {{ asistencias_paginated.total }}
                                {% if search %}<br><i class="fas fa-search"></i> "{{ search }}"{% endif %}
                            </small>
                            {% endif %}
                        </div>
                    </div>

                    {% if asistencias %}
                    <!-- Estadísticas Generales -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-chart-line"></i> Estadísticas de la Página Actual</h6>
                            <div class="row">
                                {% set total_presentes = asistencias|selectattr('asistio', 'equalto', True)|list|length %}
                                {% set total_ausentes = asistencias|selectattr('asistio', 'equalto', False)|list|length %}
                                {% set total_asistencias = asistencias|length %}
                                {% set promedio_asistencia = ((total_presentes / total_asistencias) * 100)|round|int if total_asistencias > 0 else 0 %}
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-success">
                                        <div class="card-body text-center">
                                            <h5 class="text-success">
                                                <i class="fas fa-calendar-check"></i> Total
                                            </h5>
                                            <h3 class="text-success">{{ total_asistencias }}</h3>
                                            <small class="text-muted">En esta página</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <h5 class="text-primary">
                                                <i class="fas fa-user-check"></i> Presentes
                                            </h5>
                                            <h3 class="text-primary">{{ total_presentes }}</h3>
                                            <small class="text-muted">Asistieron</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-danger">
                                        <div class="card-body text-center">
                                            <h5 class="text-danger">
                                                <i class="fas fa-user-times"></i> Ausentes
                                            </h5>
                                            <h3 class="text-danger">{{ total_ausentes }}</h3>
                                            <small class="text-muted">No asistieron</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-3 mb-3">
                                    <div class="card border-warning">
                                        <div class="card-body text-center">
                                            <h5 class="text-warning">
                                                <i class="fas fa-percentage"></i> Promedio
                                            </h5>
                                            <h3 class="text-warning">{{ promedio_asistencia }}%</h3>
                                            <small class="text-muted">De asistencia</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Total general:</strong> {{ asistencias_paginated.total }} registros de asistencia
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Tabla de asistencias -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Propietario</th>
                                    <th>Reunión</th>
                                    <th>Estado</th>
                                    <th>Ver Historial</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asistencia in asistencias %}
                                <tr>
                                    <td><strong>#{{ asistencia.id }}</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <i class="fas fa-user-circle fa-2x text-primary"></i>
                                            </div>
                                            <div>
                                                <strong>{{ asistencia.dueno.nombre }} {{ asistencia.dueno.paterno or '' }} {{ asistencia.dueno.materno or '' }}</strong>
                                                <br><small class="text-muted">CI: {{ asistencia.dueno.ci }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>{{ asistencia.reunion.titulo }}</strong>
                                        <br><small class="text-muted">{{ asistencia.reunion.fecha.strftime('%d/%m/%Y') if asistencia.reunion.fecha else 'Sin fecha' }}</small>
                                        {% if asistencia.reunion.hora %}
                                        <br><small class="text-muted">{{ asistencia.reunion.hora.strftime('%H:%M') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if asistencia.asistio %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Presente
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i> Ausente
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-info btn-sm verAsistenciasBtn"
                                            data-dueno="{{ asistencia.dueno.id }}"
                                            data-nombre="{{ asistencia.dueno.nombre }} {{ asistencia.dueno.paterno or '' }}">
                                            <i class="fas fa-eye"></i> Ver Historial
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-5">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="fas fa-users fa-3x mb-3 text-muted opacity-50"></i>
                                            <h5 class="text-muted">Sin registros</h5>
                                            <p class="mb-0">No hay registros de asistencia</p>
                                            {% if search %}
                                            <p class="mb-0">para la búsqueda "<strong>{{ search }}</strong>"</p>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <!-- Paginación -->
                        {% if asistencias_paginated and asistencias_paginated.pages > 1 %}
                        <nav aria-label="Navegación de páginas" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <!-- Botón Anterior -->
                                {% if asistencias_paginated.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('asistencia.list_asistencias', page=asistencias_paginated.prev_num, search=search) }}">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-chevron-left"></i> Anterior</span>
                                </li>
                                {% endif %}

                                <!-- Números de página -->
                                {% for page_num in asistencias_paginated.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                    {% if page_num %}
                                        {% if page_num != asistencias_paginated.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('asistencia.list_asistencias', page=page_num, search=search) }}">{{ page_num }}</a>
                                        </li>
                                        {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                        {% endif %}
                                    {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">…</span>
                                    </li>
                                    {% endif %}
                                {% endfor %}

                                <!-- Botón Siguiente -->
                                {% if asistencias_paginated.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('asistencia.list_asistencias', page=asistencias_paginated.next_num, search=search) }}">
                                        Siguiente <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">Siguiente <i class="fas fa-chevron-right"></i></span>
                                </li>
                                {% endif %}
                            </ul>
                            
                            <!-- Selector de registros por página -->
                            <div class="d-flex justify-content-center mt-3">
                                <form method="GET" action="{{ url_for('asistencia.list_asistencias') }}" class="d-flex align-items-center">
                                    <input type="hidden" name="search" value="{{ search }}">
                                    <label class="form-label mb-0 me-2">Mostrar:</label>
                                    <select name="per_page" class="form-select form-select-sm me-2" style="width: auto;" onchange="this.form.submit()">
                                        <option value="10" {% if request.args.get('per_page', '10') == '10' %}selected{% endif %}>10</option>
                                        <option value="25" {% if request.args.get('per_page') == '25' %}selected{% endif %}>25</option>
                                        <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
                                        <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100</option>
                                    </select>
                                    <span class="text-muted">por página</span>
                                </form>
                            </div>
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver historial de asistencias -->
<div class="modal fade" id="verAsistenciasModal" tabindex="-1" aria-labelledby="verAsistenciasModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="verAsistenciasModalLabel">
          <i class="fas fa-clipboard-check"></i> Historial de Asistencias - <span id="nombreDueno"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="contenidoAsistencias">
          <div class="text-center">
            <div class="spinner-border text-info" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.table-hover tbody tr:hover {
    background-color: rgba(40, 167, 69, 0.1);
}
.btn-group .btn { margin-right: 2px; }
.card-header { border-bottom: 3px solid rgba(255, 255, 255, 0.2); }
.badge { font-size: 0.75em; }

/* Estilos para paginación */
.pagination .page-link {
    color: #28a745;
}

.pagination .page-item.active .page-link {
    background-color: #28a745;
    border-color: #28a745;
    color: #fff;
}

.input-group .btn-outline-success:hover {
    background-color: #28a745;
    border-color: #28a745;
    color: #fff;
}
</style>

<script>
// Variable global para el modal
let modalAsistencias = null;

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar el modal
    const modalElement = document.getElementById('verAsistenciasModal');
    if (modalElement) {
        modalAsistencias = new bootstrap.Modal(modalElement);
    }
    
    // Manejar clicks en los botones "Ver Historial"
    document.querySelectorAll('.verAsistenciasBtn').forEach(btn => {
        btn.addEventListener('click', function() {
            const duenioId = this.dataset.dueno;
            const nombreDuenio = this.dataset.nombre;
            
            // Actualizar título del modal
            document.getElementById('nombreDueno').textContent = nombreDuenio;
            
            // Mostrar spinner mientras carga
            document.getElementById('contenidoAsistencias').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando historial de asistencias...</p>
                </div>`;
            
            // Mostrar modal
            if (modalAsistencias) {
                modalAsistencias.show();
            }
            
            // Cargar datos del historial via AJAX
            fetch(`/api/asistencias/duenio/${duenioId}`)
                .then(response => response.json())
                .then(data => {
                    mostrarHistorialAsistencias(duenioId, nombreDuenio, data);
                })
                .catch(error => {
                    console.error('Error al cargar historial:', error);
                    document.getElementById('contenidoAsistencias').innerHTML = `
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Error al cargar el historial</strong><br>
                            <small>Por favor, intente nuevamente.</small>
                        </div>`;
                });
        });
    });
});

function mostrarHistorialAsistencias(duenioId, nombreDuenio, asistenciasData) {
    // Construir la tabla de asistencias
    let contenidoHTML = `
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th><i class="fas fa-calendar text-info"></i> Fecha</th>
                        <th><i class="fas fa-clock text-warning"></i> Hora</th>
                        <th><i class="fas fa-comment text-primary"></i> Descripción</th>
                        <th><i class="fas fa-user-check text-success"></i> Estado</th>
                        <th class="text-center"><i class="fas fa-cogs"></i> Acciones</th>
                    </tr>
                </thead>
                <tbody>`;

    if (asistenciasData && asistenciasData.length > 0) {
        asistenciasData.forEach(asistencia => {
            const estadoBadge = asistencia.asistio 
                ? '<span class="badge bg-success"><i class="fas fa-check"></i> Asistió</span>'
                : '<span class="badge bg-danger"><i class="fas fa-times"></i> No asistió</span>';
            
            contenidoHTML += `
                <tr>
                    <td>
                        <strong class="text-dark">${asistencia.fecha || 'Sin fecha'}</strong>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-clock"></i> ${asistencia.hora || 'Sin hora'}
                        </span>
                    </td>
                    <td>
                        <small class="text-muted">${asistencia.descripcion || 'Reunión general'}</small>
                    </td>
                    <td>${estadoBadge}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <a href="/asistencias/${asistencia.id}/update" 
                               class="btn btn-outline-info btn-sm" 
                               title="Editar asistencia">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="confirmarEliminacion(${asistencia.id})" 
                                    class="btn btn-outline-danger btn-sm" 
                                    title="Eliminar registro">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
        
        // Calcular estadísticas
        const totalReuniones = asistenciasData.length;
        const asistenciasConfirmadas = asistenciasData.filter(a => a.asistio).length;
        const porcentaje = totalReuniones > 0 ? Math.round((asistenciasConfirmadas / totalReuniones) * 100) : 0;
        
        let colorPorcentaje = 'text-danger';
        if (porcentaje >= 80) colorPorcentaje = 'text-success';
        else if (porcentaje >= 60) colorPorcentaje = 'text-warning';
        
        contenidoHTML += `
                </tbody>
            </table>
        </div>
        
        <!-- Resumen de estadísticas -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-light border">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <i class="fas fa-calendar-check text-success"></i>
                            <strong class="d-block">Reuniones totales</strong>
                            <span class="text-muted">${totalReuniones}</span>
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-user-check text-primary"></i>
                            <strong class="d-block">Asistencias</strong>
                            <span class="text-success">${asistenciasConfirmadas}</span>
                        </div>
                        <div class="col-md-4">
                            <i class="fas fa-percent text-info"></i>
                            <strong class="d-block">Porcentaje</strong>
                            <span class="${colorPorcentaje}">${porcentaje}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    } else {
        contenidoHTML += `
            <tr>
                <td colspan="5" class="text-center text-muted py-5">
                    <div class="d-flex flex-column align-items-center">
                        <i class="fas fa-clipboard-list fa-3x mb-3 text-muted opacity-50"></i>
                        <h5 class="text-muted">Sin registros</h5>
                        <p class="mb-0">No hay registros de asistencia para <strong>${nombreDuenio}</strong></p>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>`;
    }
    
    // Actualizar contenido del modal
    document.getElementById('contenidoAsistencias').innerHTML = contenidoHTML;
}

function confirmarEliminacion(asistenciaId) {
    if (confirm('¿Está seguro de que desea eliminar este registro de asistencia?\\n\\nEsta acción no se puede deshacer.')) {
        // Crear formulario para eliminar
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/asistencias/${asistenciaId}/delete`;
        
        // Agregar token CSRF si existe
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
